variables:
  LOAD_DATAS: "true"
  EPH_ENV: "true"
  REFERENCE_ENV: "htp"
  REFERENCE_VERSION: "es16"
  MAIN_URL_PATH: "/serviceeligibility/core/ui"
  EPH_BEYOND_INSTANCE: true
  EVENTS_UPDATE_SCHEMAS: "true"

include:
  - project: "Infrastructure/CI-CD/ci"
    file: "service.yml"
    ref: "v16.0.17"

sonar:
  allow_failure: false

build:
  parallel:
    matrix:
      - LANGUAGES:
          - java
          - python
          - node

.load-datas-app-review:
  variables:
    ACTION: "restore"
    DATABASE_GROUP: "serviceeligibility-no-bobb"
    CLUSTER: "ccs2-cis-beyond-dev-01"
    COULOIR: $NAMESPACE
    RESTORE_ID: "h-blue-6909-2025-03-27"
    TOOL: mongodb

.test-service:
  retry: 0
  variables:
    ENVIRONMENT: "${TEST_NAMESPACE}"
    TARGET_ENV: "${TEST_NAMESPACE}"
  script:
    - |
      if [[ $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ ^(release|initiative) ]]; then
        ./gradlew :svc-test-main:serviceTest --tests "com.cegedim.next.serviceeligibility.core.cucumber.ServiceTestsRelease"
      else
        ./gradlew :svc-test-main:serviceTest --tests "com.cegedim.next.serviceeligibility.core.cucumber.ServiceTests" --stacktrace -Prelease.sanitizeVersion=false
      fi
  artifacts:
    expire_in: 1d
    when: always
    reports:
      junit: tests/build/test-results/**/TEST-*.xml
  allow_failure: true


.service-test-rules:
  rules:
    - if: $DISABLE_SERVICE_TEST
      when: never
    - if: $NO_SERVICE_TEST
      when: never
    - if: $FORCE_SERVICE_TEST
    # Ne pas lancer un pipeline sur un commit de branch si une merge request est ouverte
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never
    - if: $CI_COMMIT_TAG != null
      when: never
    # Ne pas lancer sur un pipeline de rebase
    - if: "$CI_PIPELINE_SOURCE == 'web' && $BRANCHE && $NEW_BASE"
      when: never
    # => RAINBOW-20
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event' && $CI_MERGE_REQUEST_TITLE !~ /^Draft:/
        && $CI_MERGE_REQUEST_LABELS =~ /TEST/
      changes:
        paths:
          - META-INF/**/*
          - src/app/**/*
          # les jobs ne sont test√©s par les jobs de services - src/job/**/*
          - src/lib/**/*
          - tests/**/*
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event' && $CI_MERGE_REQUEST_TITLE !~ /^Draft:/
        && $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME =~ /^hotfix\/([a-zA-Z]+)-([0-9]+)/
    # Sur commit des branches
    - if: $CI_COMMIT_BRANCH =~ /^(initiative)/

#config for test-env
.deploy-service:
  variables:
    VALUES_FILE: "tests/test_env_conf.yaml"
# config for appreview
.deploy-app-review:
  variables:
    VALUES_FILE: "tests/ephemeral_env_conf.yaml"
